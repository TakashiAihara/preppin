# 実装計画

## 概要

備蓄管理アプリケーションの実装を段階的に進めるためのタスクリスト。各タスクは独立して実行可能で、テスト駆動開発を基本とし、型安全性を重視した実装を行う。

## 実装タスク

- [ ] 1. プロジェクト基盤セットアップ
  - Turborepoモノレポ構成の初期化
  - 共通設定ファイル（TypeScript、Biome、lefthook）の作成
  - パッケージ間の依存関係設定
  - _要件: 全要件の基盤_

- [ ] 1.1 開発環境構築
  - Turborepo設定とワークスペース構成
  - TypeScript-Go (tsgo) コンパイラ設定
  - Biome フォーマッター・リンター設定
  - lefthook Git hooks 設定
  - _要件: 全要件の開発効率化_

- [ ] 1.2 共有型定義パッケージ作成
  - type-fest を活用した基本型定義
  - Opaque型による識別子の型安全性確保
  - neverthrow Result型の統合
  - _要件: 全要件の型安全性_

- [ ] 1.3 エラーハンドリング共通ライブラリ作成
  - neverthrow Result型ベースのエラー型定義
  - アプリケーション固有エラー型の実装
  - エラー作成ヘルパー関数の実装
  - _要件: 全要件のエラー処理_

- [ ] 2. データベース設計・実装（Prisma中心）
  - Prismaスキーマ定義とマイグレーション作成
  - zod-prisma-types による自動型生成設定
  - Grafana Stack統合設定（ログ・監視用）
  - _要件: 1.1, 2.1, 3.3, 11.1, 12.1, 13.1_

- [ ] 2.1 Prismaスキーマ定義
  - User、Organization、InventoryItem、ConsumptionLog、ActivityLogモデル定義
  - リレーション設定とインデックス最適化
  - 列挙型（Category、ExpiryType、Privacy）定義
  - _要件: 1.1, 11.1, 12.1_

- [ ] 2.2 Zodバリデーションスキーマ実装
  - zod-prisma-typesからの自動生成型活用
  - カスタムバリデーションルールの追加
  - 条件付きバリデーション（期限タイプに応じた期限日必須チェック）
  - _要件: 1.1, 2.1, 17.1_

- [ ] 2.3 データベースマイグレーション作成
  - 初期スキーママイグレーション
  - シードデータ作成スクリプト
  - テスト用データファクトリー実装
  - _要件: 全要件のデータ永続化_

- [ ] 3. 認証サービス実装（NestJS + DDD）
  - DDD/Clean Architecture基盤構築
  - Auth.js/Keycloak統合による認証機能
  - JWT トークン管理とリフレッシュ機能
  - _要件: 11.1-11.7_

- [ ] 3.1 DDD/Clean Architecture基盤実装
  - ドメイン層（エンティティ、値オブジェクト）実装
  - アプリケーション層（ユースケース、ポート）実装
  - インフラ層（Prismaリポジトリ）実装
  - _要件: 11.1, 11.5_

- [ ] 3.2 ユーザー管理機能実装
  - ユーザー登録・ログイン・ログアウト機能
  - パスワードリセット機能
  - メール認証機能
  - _要件: 11.1-11.7_

- [ ] 3.3 トークン管理機能実装
  - Access Token（15分有効期限）実装
  - Refresh Token（7日有効期限）実装
  - Token Rotation機能
  - _要件: 11.5, 11.6_

- [ ] 4. 組織管理サービス実装（NestJS + DDD）
  - 組織ドメインモデル実装
  - 組織作成・管理ユースケース
  - メンバー招待・権限管理機能
  - _要件: 12.1-12.7, 14.1-14.6_

- [ ] 4.1 組織CRUD機能実装
  - 組織作成・更新・削除機能
  - 招待コード生成・管理機能
  - プライバシー設定機能
  - _要件: 12.1, 12.2_

- [ ] 4.2 メンバー管理機能実装
  - メンバー招待機能（メール・招待コード）
  - 権限管理（admin/editor/viewer）
  - メンバー一覧・活動統計表示
  - _要件: 12.3, 12.4, 12.7, 14.3_

- [ ] 4.3 組織権限チェック機能実装
  - リソースレベル認可機能
  - 権限チェックミドルウェア
  - 組織メンバーシップ検証
  - _要件: 12.5, 12.7, 14.1_

- [ ] 5. 備蓄品管理サービス実装（NestJS + DDD）
  - 備蓄品ドメインモデル・集約実装
  - 備蓄品管理ユースケース実装
  - Prismaリポジトリパターン実装
  - _要件: 1.1-1.4, 3.1-3.4, 6.1-6.5, 7.1-7.6, 18.1-18.9_

- [ ] 5.1 備蓄品CRUD機能実装
  - 備蓄品作成・更新・削除機能
  - バリデーション機能（Zodスキーマ活用）
  - 画像アップロード機能統合
  - _要件: 1.1-1.4_

- [ ] 5.2 期限管理機能実装
  - 消費期限・賞味期限の2軸管理
  - 期限切れ近商品検索機能
  - 期限アラート機能（3日、7日、30日前）
  - _要件: 2.1-2.9, 17.1-17.8_

- [ ] 5.3 在庫管理機能実装
  - 最小在庫数設定・アラート機能
  - 補充リスト自動生成機能
  - 在庫数更新・履歴記録機能
  - _要件: 3.1-3.4_

- [ ] 5.4 検索・フィルタリング機能実装
  - 全文検索機能（商品名、ブランド名、説明文）
  - 複合検索機能（カテゴリ、保管場所、期限状態、タグ）
  - 高度な検索機能（期限日範囲、価格範囲、数量範囲）
  - _要件: 18.1-18.9_

- [ ] 5.5 消費記録・履歴管理機能実装
  - 消費記録機能（数量、理由、日時）
  - 消費履歴表示・分析機能
  - 消費パターン分析・予測機能
  - _要件: 7.1-7.6_

- [ ] 6. Protocol Buffers・gRPCサービス実装
  - .protoファイル定義
  - gRPCサーバー実装
  - 認証・認可ミドルウェア統合
  - _要件: 全要件のAPI通信_

- [ ] 6.1 Protocol Buffers定義
  - 共通型定義（common.proto）
  - 認証サービス定義（auth.proto）
  - 備蓄品サービス定義（inventory.proto）
  - 組織管理サービス定義（organization.proto）
  - _要件: 全要件の型安全性_

- [ ] 6.2 認証gRPCサービス実装
  - 登録・ログイン・ログアウト実装
  - トークンリフレッシュ実装
  - パスワードリセット実装
  - _要件: 11.1-11.7_

- [ ] 6.3 組織管理gRPCサービス実装
  - 組織CRUD 実装
  - メンバー管理実装
  - 権限チェック統合
  - _要件: 12.1-12.7, 14.1-14.6_

- [ ] 6.4 備蓄品管理gRPCサービス実装
  - 備蓄品CRUD 実装
  - 検索・フィルタリング実装
  - 消費記録実装
  - _要件: 1.1-1.4, 3.1-3.4, 7.1-7.6, 18.1-18.9_

- [ ] 6.5 商品情報gRPCサービス実装
  - バーコード商品情報取得実装
  - ASIN商品情報取得実装
  - 外部API統合
  - _要件: 10.1-10.7_

- [ ] 6.6 tRPCルーター実装（Web管理画面専用）
  - gRPCサービスのtRPCラッパー実装
  - Web管理画面向け最適化
  - React Query統合
  - _要件: 9.1-9.6_

- [ ] 7. Admin BFF（Hono）実装（Web管理画面専用）
  - tRPCプロキシ機能
  - gRPCサービス連携
  - レート制限・セキュリティヘッダー
  - _要件: 9.1-9.6のWeb管理画面_

- [ ] 7.1 Admin BFF基盤構築
  - Honoサーバー基盤構築（Web管理画面専用）
  - tRPCルーター設定
  - gRPCクライアント統合
  - _要件: 9.1-9.6_

- [ ] 7.2 tRPC-gRPC ブリッジ実装
  - gRPCサービスのtRPCラッパー実装
  - 型安全な変換レイヤー
  - エラーハンドリング統合
  - _要件: 9.1-9.6_

- [ ] 7.3 セキュリティ機能実装
  - レート制限機能
  - セキュリティヘッダー設定
  - CORS設定
  - _要件: 9.1-9.6のセキュリティ_

- [ ] 7.4 外部向けREST API実装
  - 外部システム連携用REST API
  - API キー認証機能
  - OpenAPI仕様書生成
  - _要件: 外部システム連携_

- [ ] 8. 共有UIコンポーネント実装（shadcn/ui）
  - TailwindCSS設定
  - 基本UIコンポーネント
  - ビジネス固有コンポーネント
  - _要件: 全要件のUI表示_

- [ ] 8.1 TailwindCSS・shadcn/ui セットアップ
  - TailwindCSS設定（カスタムカラー、ダークモード）
  - shadcn/ui基本コンポーネント導入
  - デザインシステム構築
  - _要件: 全要件のUI基盤_

- [ ] 8.2 基本UIコンポーネント実装
  - Button、Input、Card、Table、Dialog等
  - Form、Select、Calendar、Badge等
  - Toast、Loading、ErrorBoundary等
  - _要件: 全要件のUI部品_

- [ ] 8.3 ビジネス固有コンポーネント実装
  - ExpiryBadge（期限管理バッジ）
  - InventoryCard（備蓄品カード）
  - QuantityInput（数量入力）
  - MemberAvatar（メンバーアバター）
  - _要件: 1.1-1.4, 2.1-2.9, 12.1-12.7_

- [ ] 9. Flutter状態管理実装（Riverpod）
  - 認証状態管理
  - 備蓄品状態管理
  - 組織状態管理
  - _要件: 全要件のクライアント状態_

- [ ] 9.1 認証状態管理実装（Riverpod）
  - ユーザー情報・認証状態プロバイダー
  - 組織情報・現在組織プロバイダー
  - 永続化設定（shared_preferences）
  - _要件: 11.1-11.7, 12.1-12.7_

- [ ] 9.2 備蓄品状態管理実装（Riverpod）
  - 備蓄品一覧・フィルタリングプロバイダー
  - 検索クエリ・選択状態プロバイダー
  - 楽観的更新・キャッシュ機能
  - _要件: 1.1-1.4, 18.1-18.9_

- [ ] 9.3 組織状態管理実装（Riverpod）
  - 組織情報・メンバー情報プロバイダー
  - 活動フィード状態プロバイダー
  - 権限情報キャッシュプロバイダー
  - _要件: 12.1-12.7, 15.1-15.6_

- [ ] 9.4 Web管理画面状態管理実装（Zustand + Immer）
  - Web管理画面専用状態管理
  - tRPC統合状態管理
  - ダッシュボード状態管理
  - _要件: 9.1-9.6_

- [ ] 10. Flutter モバイルアプリ実装
  - Flutter プロジェクト基盤構築
  - gRPC クライアント統合
  - Clean Architecture実装
  - _要件: 1.1-1.4, 10.1-10.7, 16.1-16.8_

- [ ] 10.1 Flutter プロジェクト基盤構築
  - Flutter プロジェクト作成・設定
  - 依存関係設定（Riverpod、gRPC、カメラ等）
  - ディレクトリ構造構築（Clean Architecture）
  - _要件: 全要件のモバイル基盤_

- [ ] 10.2 Protocol Buffers・gRPC設定
  - .protoファイル配置・設定
  - Dart コード自動生成設定
  - gRPC クライアント基盤実装
  - _要件: 全要件のAPI通信_

- [ ] 10.3 データ層実装
  - gRPC データソース実装
  - ローカルストレージ（Hive/SQLite）実装
  - リポジトリパターン実装
  - _要件: 5.1, 全要件のデータ永続化_

- [ ] 10.4 ドメイン層実装
  - エンティティ・値オブジェクト定義
  - ユースケース実装
  - リポジトリインターフェース定義
  - _要件: 1.1-1.4, 7.1-7.6_

- [ ] 10.5 プレゼンテーション層基盤実装
  - Riverpod プロバイダー設定
  - ナビゲーション設定（GoRouter）
  - テーマ・デザインシステム構築
  - _要件: 全要件のUI基盤_

- [ ] 10.6 認証画面実装
  - ログイン・登録画面
  - パスワードリセット画面
  - 組織選択画面
  - _要件: 11.1-11.7, 12.1-12.7_

- [ ] 10.7 備蓄品管理画面実装
  - 備蓄品一覧画面（検索・フィルタ機能付き）
  - 備蓄品詳細・編集画面
  - 備蓄品追加画面
  - _要件: 1.1-1.4, 18.1-18.9_

- [ ] 10.8 バーコードスキャン機能実装
  - カメラ権限管理
  - JANコード読み取り機能（mobile_scanner）
  - 商品情報自動入力機能
  - _要件: 10.1-10.7_

- [ ] 10.9 写真管理機能実装
  - 写真撮影・選択機能（image_picker）
  - 画像圧縮・アップロード機能
  - ギャラリー表示機能
  - _要件: 16.1-16.8_

- [ ] 10.10 オフライン機能実装
  - ローカルデータベース同期機能
  - オフライン状態検知・UI表示
  - データ競合解決機能
  - _要件: 5.1-5.4_

- [ ] 11. React Web管理画面実装
  - ダッシュボード・統計表示
  - 備蓄品管理テーブル
  - 組織・メンバー管理画面
  - _要件: 9.1-9.6, 14.1-14.6, 15.1-15.6_

- [ ] 11.1 Web管理画面基盤構築
  - Vite + React セットアップ
  - React Router ナビゲーション
  - レスポンシブレイアウト
  - _要件: 9.1-9.6_

- [ ] 11.2 ダッシュボード実装
  - 在庫状況サマリー表示
  - 期限切れ近商品アラート
  - 消費統計グラフ表示
  - _要件: 9.4_

- [ ] 11.3 備蓄品管理テーブル実装
  - 備蓄品一覧テーブル（検索・ソート・フィルタ）
  - 一括編集・CSV インポート/エクスポート
  - 詳細モーダル・編集フォーム
  - _要件: 9.2, 9.3_

- [ ] 11.4 組織・メンバー管理画面実装
  - メンバー一覧・権限管理
  - 招待機能・活動ログ表示
  - 組織設定・統計表示
  - _要件: 14.1-14.6, 15.1-15.6_

- [ ] 12. MSWモック実装
  - tRPC対応モックハンドラー
  - リアルなテストデータ
  - 開発・テスト環境統合
  - _要件: 全要件の開発・テスト支援_

- [ ] 12.1 MSW基盤構築
  - MSWセットアップ・設定
  - tRPC対応ハンドラー基盤
  - ブラウザ・Node.js両対応
  - _要件: 全要件のモック基盤_

- [ ] 12.2 認証・組織モックハンドラー実装
  - 認証関連APIモック
  - 組織管理APIモック
  - リアルなユーザー・組織データ
  - _要件: 11.1-11.7, 12.1-12.7_

- [ ] 12.3 備蓄品管理モックハンドラー実装
  - 備蓄品CRUD APIモック
  - 検索・フィルタリングモック
  - 消費記録・履歴モック
  - _要件: 1.1-1.4, 7.1-7.6, 18.1-18.9_

- [ ] 13. テスト実装
  - 単体テスト（Vitest）
  - 統合テスト（API・データベース）
  - E2Eテスト（Stagehand）
  - _要件: 全要件の品質保証_

- [ ] 13.1 単体テスト実装
  - ユーティリティ関数テスト
  - バリデーション関数テスト
  - コンポーネントテスト（Testing Library）
  - _要件: 全要件の単体品質_

- [ ] 13.2 統合テスト実装
  - API エンドポイントテスト（Supertest）
  - データベース操作テスト（Testcontainers）
  - サービス間連携テスト
  - _要件: 全要件の統合品質_

- [ ] 13.3 E2Eテスト実装（Stagehand）
  - 主要ユーザーフローテスト
  - 備蓄品管理フローテスト
  - 組織管理・共有フローテスト
  - _要件: 全要件のエンドツーエンド品質_

- [ ] 14. Railway初期デプロイ
  - Railway設定・サービス構成
  - 環境変数・シークレット管理
  - データベース・キャッシュ設定
  - _要件: 全要件の初期デプロイ_

- [ ] 14.1 Railway基盤構築
  - Railway プロジェクト作成
  - サービス設定（BFF、各マイクロサービス）
  - 環境変数・シークレット設定
  - _要件: 全要件のデプロイ基盤_

- [ ] 14.2 データベース・キャッシュ設定
  - PostgreSQL サービス設定
  - Grafana Stack設定
  - Valkey（Redis互換）サービス設定
  - _要件: 全要件のデータ永続化_

- [ ] 14.3 CI/CD パイプライン構築
  - GitHub Actions設定
  - 自動テスト・ビルド・デプロイ
  - 環境別デプロイ設定
  - _要件: 全要件の自動化_

- [ ] 15. 本格運用インフラ実装（将来拡張）
  - クラウドデータベース構築
  - 監視・ログ設定
  - スケーリング対応
  - _要件: 全要件の本格運用_

- [ ] 15.1 クラウドデータベース構築
  - PostgreSQL マネージドサービス設定
  - Grafana Stack統合
  - Valkey クラスター構築
  - _要件: 全要件のデータ基盤_

- [ ] 15.2 監視・ログ設定
  - アプリケーション監視設定
  - ログ集約・分析設定
  - アラート・通知設定
  - _要件: 全要件の運用監視_

- [ ] 15.3 スケーリング・パフォーマンス対応
  - 負荷分散設定
  - オートスケーリング設定
  - パフォーマンス最適化
  - _要件: 全要件のスケーラビリティ_

## 実装順序の考慮事項

### フェーズ1: 基盤構築（タスク1-3）
- 開発環境・ツールチェーン構築
- 型安全性・品質ゲート確立
- 認証基盤構築

### フェーズ2: コア機能実装（タスク4-7）
- 組織管理・備蓄品管理サービス
- tRPC API・BFF実装
- 基本的なCRUD機能完成

### フェーズ3: UI・UX実装（タスク8-11）
- 共有コンポーネント・状態管理
- モバイルアプリ・Web管理画面
- ユーザー体験の完成

### フェーズ4: 品質・運用（タスク12-15）
- テスト・モック実装
- デプロイ・インフラ構築
- 本格運用準備

各タスクは独立して実行可能で、並行開発が可能な構成になっています。